<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Siedlerâ€‘Mini â€” Filelist (GitHub)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:16px}
  input,button{font-size:16px;padding:10px;border:1px solid #ccc;border-radius:8px}
  label{display:block;margin:12px 0 6px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .muted{color:#666}
  pre{background:#f6f8fa;padding:12px;border-radius:8px;white-space:pre-wrap}
  a.btn{display:inline-block;margin-right:8px;margin-top:8px}
</style>
</head>
<body>
<h1>ðŸ“‚ Siedlerâ€‘Mini â€” Filelist (GitHub)</h1>
<p>Erzeugt <code>filelist.txt</code> &amp; <code>filelist.json</code> aus deinem Ã¶ffentlichen GitHubâ€‘Repo â€“ funktioniert auf iPhone/iPad.</p>

<div class="row">
  <div>
    <label>Owner</label>
    <input id="owner" value="DrHoschi">
  </div>
  <div>
    <label>Repo</label>
    <input id="repo" value="siedler-mini">
  </div>
  <div>
    <label>Branch / Ref</label>
    <input id="ref" value="heads/main">
  </div>
</div>

<div class="row" style="margin-top:10px">
  <div>
    <label>Nur Pfade unter â€¦ (Prefixâ€‘Filter)</label>
    <input id="prefix" value="main/">
  </div>
</div>

<div class="row" style="margin-top:12px">
  <button id="run">Generate</button>
  <span id="status" class="muted"></span>
</div>

<h3>Vorschau</h3>
<pre id="preview">Noch keine Ausgabe.</pre>

<script type="module">
const $ = s => document.querySelector(s);
const apiTree = (o,r,ref)=>`https://api.github.com/repos/${encodeURIComponent(o)}/${encodeURIComponent(r)}/git/trees/${encodeURIComponent(ref)}?recursive=1`;
const ghBlob = (o,r,b,p)=>`https://github.com/${encodeURIComponent(o)}/${encodeURIComponent(r)}/blob/${encodeURIComponent(b)}/${p}`;
const rawURL = (o,r,b,p)=>`https://raw.githubusercontent.com/${encodeURIComponent(o)}/${encodeURIComponent(r)}/${encodeURIComponent(b)}/${p}`;

function download(name, text, type="text/plain;charset=utf-8"){
  const blob = new Blob([text],{type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = name; a.click();
  URL.revokeObjectURL(url);
}

function toTxt(list){
  return list.map(e=>{
    const size = (e.type==="file" && Number.isFinite(e.size)) ? `  (${e.size} B)` : "";
    return `${e.path}${size}\n  GH:  ${e.github}\n  RAW: ${e.raw}`;
  }).join("\n")+"\n";
}

$("#run").addEventListener("click", async ()=>{
  const owner = $("#owner").value.trim();
  const repo  = $("#repo").value.trim();
  const ref   = $("#ref").value.trim();        // z.B. "heads/main" oder Commitâ€‘SHA
  const prefix= $("#prefix").value.trim();     // z.B. "main/"

  $("#status").textContent = "â€¦lade Gitâ€‘Baum (GitHub API)";
  $("#preview").textContent = "Bitte wartenâ€¦";

  try{
    const res = await fetch(apiTree(owner, repo, ref));
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const branch = ref.replace(/^heads\//,""); // "heads/main" â†’ "main"
    const nodes = (data.tree||[])
      .filter(n => !prefix || (n.path && n.path.startsWith(prefix)))
      .sort((a,b)=> a.path.localeCompare(b.path));

    // in maschinenlesbare & textâ€‘Liste umwandeln
    const list = nodes.map(n=>{
      const type = (n.type==="blob")?"file":"dir";
      const size = (type==="file") ? (n.size??null) : null;
      return {
        type,
        path: n.path,
        size,
        github: ghBlob(owner, repo, branch, n.path),
        raw: rawURL(owner, repo, branch, n.path)
      };
    });

    // Vorschau + Downloads
    const txt = toTxt(list);
    const json = JSON.stringify({ createdAt:new Date().toISOString(), owner, repo, branch, prefix, count:list.length, entries:list }, null, 2);

    $("#preview").textContent = txt.slice(0,10000) + (txt.length>10000 ? "\nâ€¦(gekÃ¼rzt)" : "");
    $("#status").textContent = "Fertig. Dateien werden heruntergeladenâ€¦";

    download("filelist.txt", txt);
    download("filelist.json", json, "application/json;charset=utf-8");

    $("#status").textContent = `OK: ${list.length} EintrÃ¤ge.`;
  }catch(err){
    $("#status").textContent = "Fehler: " + err;
    $("#preview").textContent = "Fehler: " + err;
  }
});
</script>
<p class="muted">Hinweis: FÃ¼r private Repos brÃ¤uchtest du einen Token â€“ hier nicht nÃ¶tig, da <b>Ã¶ffentlich</b>.</p>
</body>
</html>
