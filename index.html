<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Siedler Mini – Prototype</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#12161c" />

  <!-- ============================================================
       index.html • v1.13
       CHANGES:
       - Road-Overlay-Render via game.js v1.13
       - Render-Reihenfolge: Boden → Straßen → Units → Gebäude → HUD
       - Baumenü bleibt direkt unter der Ressourcenleiste gedockt
       - Kommentar-Banner & Insert-Marker vorhanden
       ============================================================ -->

  <style>
    :root{
      --bg:#0f1318;--panel:#1a2230;--glass:rgba(16,23,34,.65);
      --text:#e8eef6;--muted:#96a2b6;--accent:#3b82f6;
      --ok:#22c55e;--warn:#eab308;--danger:#ef4444;
      --radius:14px;--blur:10px
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#0b0f14;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    button{cursor:pointer}
    .btn{background:#1f2a3a;border:1px solid #ffffff14;color:#e9eef7;padding:10px 14px;border-radius:12px;font-weight:600;display:inline-flex;gap:8px;align-items:center}
    .btn.primary{background:#2a3b55;border-color:#3b82f650}
    .btn.danger{background:#3a2226;border-color:#ef444450}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grow{flex:1 1 auto}

    /* ====== Bühne / Hintergrund ====== */
    #stage{position:fixed;inset:0;display:block;touch-action:none;background:#0b120b}
    #backdrop{position:fixed;inset:0;background:#000 url("./assets/Logo.PNG") center/contain no-repeat;opacity:.9;transition:opacity .5s;pointer-events:none;z-index:5}

    /* ====== Startpanel ====== */
    #startPanel{position:fixed;inset:0;display:grid;place-items:center;z-index:20;background:rgba(0,0,0,.55);backdrop-filter: blur(6px)}
    #startCard{width:min(680px,92vw);padding:20px;border-radius:18px;background:#12161ccc;border:1px solid #ffffff10}

    /* ====== HUD oben links (Ressourcen) ====== */
    #hud{position:fixed;left:8px;top:8px;z-index:12;min-width:280px;padding:10px;border-radius:16px;background:var(--glass);backdrop-filter:blur(var(--blur));border:1px solid #ffffff14}
    #versionSmall{font-weight:800;font-size:.85rem;opacity:.85;margin-bottom:8px}
    #resbar{display:flex;gap:18px;align-items:center;background:#0c101a80;border-radius:12px;padding:10px;border:1px solid #ffffff10}
    .res{display:grid;grid-template-columns:auto auto;gap:8px 10px;align-items:center}
    .res .val{min-width:28px;text-align:right}
    .ico{width:18px;height:18px;opacity:.92;display:inline-block;vertical-align:-3px}

    /* ====== Build-Menü (angedockt unter HUD) ====== */
    #buildMenu{
      position:fixed; left:8px; z-index:12;
      background:var(--glass); backdrop-filter:blur(var(--blur));
      border:1px solid #ffffff19; border-radius:16px; padding:10px 12px; min-width:280px;
    }
    #buildTitle{font-weight:800;margin:2px 0 8px 2px}
    #buildGroups{display:flex;flex-direction:column;gap:10px}
    .group{background:#101722a8;border:1px solid #ffffff0f;border-radius:12px;padding:10px}
    .group h4{margin:0 0 8px 0;font-size:.9rem;color:#cfd7e6}
    #buildTools{display:flex;flex-wrap:wrap;gap:8px}
    .tool{
      display:flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:12px;background:#1f2a3a;border:1px solid #ffffff14;min-width:44px
    }
    .tool .ticon{width:18px;height:18px;opacity:.95}
    .tool.active{outline:2px solid var(--accent)}
    .tool.disabled{opacity:.5;filter:saturate(.6)}
    .tool.shake{animation:shake .25s}
    @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-2px)}50%{transform:translateX(2px)}75%{transform:translateX(-2px)}100%{transform:translateX(0)}}

    #buildReopen{position:fixed;left:8px;z-index:12;display:none;background:var(--glass);border:1px solid #ffffff14;border-radius:12px;padding:8px 10px}

    /* ====== Toast / Inspector ====== */
    #toast{position:fixed;left:10px;right:10px;bottom:10px;z-index:30;display:flex;gap:12px;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:16px;background:var(--glass);backdrop-filter:blur(var(--blur));border:1px solid #ffffff14}
    #inspector{position:fixed;left:10px;right:10px;bottom:70px;z-index:28;display:none;background:#1a2230;border:1px solid #ffffff14;border-radius:16px;padding:12px}
    #log{max-height:28vh;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;line-height:1.3;background:#0d121a;border-radius:10px;padding:10px;border:1px solid #ffffff10}

    /* ====== Vollbild Buttons ====== */
    #fsEnter,#fsExit{position:fixed;right:10px;top:10px;z-index:14;border-radius:12px;border:1px solid #ffffff14;background:var(--glass);backdrop-filter:blur(var(--blur));padding:8px 10px}
    #fsExit{display:none}
  </style>
</head>
<body>

  <!-- ================= STAGE / BACKDROP ================= -->
  <canvas id="stage"></canvas>
  <div id="backdrop" aria-hidden="true"></div>

  <!-- ================= STARTPANEL ================= -->
  <div id="startPanel" role="dialog" aria-modal="true">
    <div id="startCard">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <div style="font-weight:800;font-size:1.1rem">Siedler Mini</div>
        <div style="opacity:.7">Build <span id="buildDate"></span></div>
      </div>
      <div class="row" style="margin-bottom:10px">
        <select id="mapSelect" class="btn grow" style="background:#1b2433"> 
          <option value="./assets/maps/map-mini.json">Mini-Map (Test)</option>
          <option value="./assets/maps/map-demo.json">Demo</option>
          <option value="./assets/maps/map-test-all.json">Test-All</option>
          <option value="./assets/maps/map-pro.json">Pro</option>
        </select>
        <button id="btnNew" class="btn primary">Neues Spiel</button>
        <button id="btnCont" class="btn">Weiterspielen</button>
      </div>
      <div class="row" style="margin-bottom:10px">
        <button id="btnReset" class="btn danger">Reset</button>
        <div class="grow"></div><span class="note" style="color:var(--muted)">Vollbild oben rechts.</span>
      </div>
      <div class="note" style="color:var(--muted)">Editor & Live‑Malen in der Toast‑Leiste.</div>
    </div>
  </div>

  <!-- ================= HUD (Ressourcen) ================= -->
  <div id="hud" aria-live="polite" aria-atomic="true">
    <div id="versionSmall">V?.?.? • <span id="versionDate"></span></div>
    <div id="resbar" class="res">
      <span>
        <svg class="ico" viewBox="0 0 24 24"><path fill="currentColor" d="M7 3l10 4-4 10-10-4z"/></svg> Holz
      </span><span class="val" id="res-wood">0</span>
      <span>
        <svg class="ico" viewBox="0 0 24 24"><path fill="currentColor" d="M4 16l4-10h8l4 10-8 5z"/></svg> Stein
      </span><span class="val" id="res-stone">0</span>
      <span>
        <svg class="ico" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4" fill="currentColor"/><path d="M4 20c2-4 14-4 16 0" fill="currentColor"/></svg> Nahrung
      </span><span class="val" id="res-food">0</span>
      <span>
        <svg class="ico" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12a4 4 0 110-8 4 4 0 010 8zm-7 9a7 7 0 0114 0"/></svg> Bew.
      </span><span class="val" id="res-pop">0</span>
    </div>
  </div>

  <!-- ================= BUILD-MENÜ (angedockt) ================= -->
  <div id="buildMenu">
    <div id="buildTitle">Baumenü</div>

    <div id="buildGroups">
      <!-- Grundwerkzeuge -->
      <div class="group">
        <h4>Grundwerkzeuge</h4>
        <div id="buildTools">
          <button class="tool" data-tool="road" title="Straße">
            <svg class="ticon" viewBox="0 0 24 24"><path fill="currentColor" d="M9 2h6v20H9zM2 9h20v6H2z"/></svg><span>Straße</span>
          </button>
          <button class="tool" data-tool="hut" title="Hütte">
            <svg class="ticon" viewBox="0 0 24 24"><path fill="currentColor" d="M3 11l9-7 9 7v9H3zM8 20v-6h8v6"/></svg><span>Hütte</span>
          </button>
          <button class="tool" data-tool="lumber" title="Holzfäller">
            <svg class="ticon" viewBox="0 0 24 24"><path fill="currentColor" d="M4 20l6-6-2-2-6 6v2h2zM13 5l6 6 2-2-6-6-2 2z"/></svg><span>Holzfäller</span>
          </button>
          <button class="tool" data-tool="mason" title="Steinbruch">
            <svg class="ticon" viewBox="0 0 24 24"><path fill="currentColor" d="M3 17l6-10 6 10H3zm12 0l3-5 3 5h-6z"/></svg><span>Steinbruch</span>
          </button>
        </div>
      </div>

      <!-- Epoche I – Holzbau (aus assets/tex/building/wood) -->
      <div class="group">
        <h4>Epoche I – Holzbau</h4>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <button class="tool" data-tool="hq_wood" title="HQ (Holz)"><svg class="ticon" viewBox="0 0 24 24"><path fill="currentColor" d="M3 12l9-7 9 7v8H3z"/></svg><span>HQ</span></button>
          <button class="tool" data-tool="hq_wood_ug1" title="HQ Upgrade I"><svg class="ticon" viewBox="0 0 24 24"><path fill="currentColor" d="M2 12l10-8 10 8v9H2zM8 21v-6h8v6"/></svg><span>HQ UG1</span></button>

          <button class="tool" data-tool="depot_wood" title="Depot"><svg class="ticon" viewBox="0 0 24 24"><path fill="currentColor" d="M4 10l8-5 8 5v9H4z"/></svg><span>Depot</span></button>
          <button class="tool" data-tool="depot_wood_ug" title="Depot Upgrade"><svg class="ticon" viewBox="0 0 24 24"><path fill="currentColor" d="M4 10l8-5 8 5v9H4zM8 19v-5h8v5"/></svg><span>Depot UG</span></button>

          <button class="tool" data-tool="lumberjack_wood" title="Holzhütte"><svg class="ticon" viewBox="0 0 24 24"><path fill="currentColor" d="M3 12l7-5 7 5v7H3z"/></svg><span>Holzhütte</span></button>
          <button class="tool" data-tool="stonebraker_wood" title="Steinbrecher"><svg class="ticon" viewBox="0 0 24 24"><path fill="currentColor" d="M4 18l4-9h8l4 9H4z"/></svg><span>Steinbrecher</span></button>

          <button class="tool" data-tool="farm_wood" title="Farm"><svg class="ticon" viewBox="0 0 24 24"><path fill="currentColor" d="M3 17h18v3H3zM4 14l8-6 8 6H4z"/></svg><span>Farm</span></button>
          <button class="tool" data-tool="baeckerei_wood" title="Bäckerei"><svg class="ticon" viewBox="0 0 24 24"><path fill="currentColor" d="M5 10h14v9H5zM7 7h10l2 3H5"/></svg><span>Bäckerei</span></button>

          <button class="tool" data-tool="fischer_wood1" title="Fischerhütte"><svg class="ticon" viewBox="0 0 24 24"><path fill="currentColor" d="M3 12l7-5 7 5v7H3zM15 6c1.7 0 3-1.3 3-3"/></svg><span>Fischer</span></button>

          <button class="tool" data-tool="wassermuehle_wood" title="Wassermühle"><svg class="ticon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3l3 5-3 5-3-5 3-5zm-7 15h14v3H5z"/></svg><span>Wassermühle</span></button>
          <button class="tool" data-tool="windmuehle_wood" title="Windmühle"><svg class="ticon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12l8-3-3 8-5-5-5 5-3-8 8 3z"/></svg><span>Windmühle</span></button>

          <button class="tool" data-tool="haeuser_wood1" title="Haus 1"><svg class="ticon" viewBox="0 0 24 24"><path fill="currentColor" d="M4 12l8-6 8 6v8H4z"/></svg><span>Haus 1</span></button>
          <button class="tool" data-tool="haeuser_wood1_ug1" title="Haus 1 UG1"><svg class="ticon" viewBox="0 0 24 24"><path fill="currentColor" d="M4 12l8-6 8 6v8H4zM8 20v-6h8v6"/></svg><span>Haus 1 UG1</span></button>
          <button class="tool" data-tool="haeuser_wood2" title="Haus 2"><svg class="ticon" viewBox="0 0 24 24"><path fill="currentColor" d="M5 12l7-5 7 5v8H5z"/></svg><span>Haus 2</span></button>
        </div>
      </div>
    </div>
  </div>
  <button id="buildReopen" title="Baumenü öffnen">🧱 Bauen</button>

  <!-- ================= FS + TOAST + INSPECTOR ================= -->
  <button id="fsEnter" title="Vollbild">⛶</button>
  <button id="fsExit"  title="Vollbild verlassen">✕</button>

  <div id="toast" role="region" aria-label="Utility-Leiste">
    <div class="left"><button id="btnMenu" class="btn">Menü</button></div>
    <div class="right">
      <button id="btnInspector" class="btn">Inspector</button>
      <button id="btnCache" class="btn">Cache leeren</button>
      <button id="btnEditor" class="btn">Editor</button>
      <button id="btnPaint" class="btn">Live‑Malen</button>
      <button id="btnUndo" class="btn">Undo</button>
      <button id="btnRedo" class="btn">Redo</button>
    </div>
  </div>

  <div id="inspector">
    <div class="row" style="justify-content:space-between;margin-bottom:8px">
      <strong>Dev‑Inspector</strong>
      <div class="seg">
        <button id="btnLogMax" class="btn">Max</button>
        <button id="btnCopyPaths" class="btn">Copy Pfad‑Liste</button>
        <button id="btnExportJson" class="btn">Export JSON</button>
        <button id="btnCloseInspector" class="btn">Close</button>
      </div>
    </div>
    <div id="log" aria-live="polite"></div>
  </div>

  <!-- ================= SCRIPT-MODULE: ASSET LOADER ================= -->
  <script>
  window.Asset = window.Asset || (function(){
    const cache = new Map(); let texturesReady=false;
    async function loadImage(key, url){
      if(cache.has(url)) return cache.get(url);
      return new Promise((res,rej)=>{
        const img=new Image(); img.crossOrigin="anonymous";
        img.onload=()=>{ cache.set(url,img); res(img); };
        img.onerror=()=>rej(new Error('IMG '+url)); img.src=url;
      });
    }
    return { loadImage, markTexturesReady(v){texturesReady=!!v;}, areTexturesReady(){return texturesReady;}, _cache:cache };
  })();
  </script>

  <!-- ================= HIER: SPIEL/BOOT SCRIPTS EINBINDEN ================= -->
  <script src="./game.js"></script>
  <script src="./boot.js"></script>

  <!-- ================= UI/LOGIK (Docking + Events) ================= -->
  <script>
  (function(){
    const $ = (s)=>document.querySelector(s);
    const log = (...a)=> (window.BootUI?.dbg ? BootUI.dbg(...a) : console.log(...a));
    BootUI = window.BootUI || {};
    BootUI.dbg = BootUI.dbg || function(){ console.log('[DBG]', ...arguments); };

    // ---- Version/Build Datum
    const today=new Date(), y=today.getFullYear(), m=String(today.getMonth()+1).padStart(2,'0'), d=String(today.getDate()).padStart(2,'0');
    $('#buildDate').textContent=`${y}${m}${d}`; $('#versionDate').textContent=`${y}${m}${d}`;

    // ---- Startpanel
    $('#btnNew').addEventListener('click', async ()=>{
      const map=$('#mapSelect').value;
      if(confirm('Neues Spiel starten? Bestehende Spielstände können überschrieben werden.')){ hideStart(); await window.GameLoader.start(map); }
    });
    $('#btnCont').addEventListener('click', async ()=>{ hideStart(); BootUI.continueLastSnapshot?.(); });
    $('#btnReset').addEventListener('click', ()=>{ if(confirm('Wirklich alle Spielstände löschen?')){ try{localStorage.clear(); location.reload();}catch{} }});
    function hideStart(){ $('#startPanel').style.display='none'; }

    // ---- Toast / Inspector / FS
    $('#btnMenu').addEventListener('click', ()=> $('#startPanel').style.display='grid'));
    $('#btnInspector').addEventListener('click', ()=> $('#inspector').style.display='block'));
    $('#btnCache').addEventListener('click', ()=>{ if(confirm('Cache leeren?')){ localStorage.clear(); location.reload(); }});
    $('#btnCloseInspector').addEventListener('click', ()=> $('#inspector').style.display='none'));

    const fsEnter=$('#fsEnter'), fsExit=$('#fsExit');
    fsEnter.addEventListener('click', ()=>{ const el=document.documentElement, go=el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen; go?.call(el)?.then(()=>{fsEnter.style.display='none';fsExit.style.display='inline-block'}) });
    fsExit.addEventListener('click', ()=>{ const ex=document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen; ex?.call(document)?.finally(()=>{fsExit.style.display='none';fsEnter.style.display='inline-block'}) });

    // ---- Backdrop Fade (Textures Ready/Timeout)
    (function(){ const bd=$('#backdrop'); let t=setTimeout(()=>{BootUI.dbg('Textures TIMEOUT → fade');bd.style.opacity='0';setTimeout(()=>bd.style.display='none',1200)},60000);
      const tick=()=>{ if(window.Asset?.areTexturesReady?.()){BootUI.dbg('Textures READY -> fade');clearTimeout(t);bd.style.opacity='0';setTimeout(()=>{bd.style.display='none';BootUI.dbg('Backdrop hidden')},3000)} else requestAnimationFrame(tick) }; tick();
    })();

    // ---- Build-Menü Show/Hide via Doppelklick + Reopen
    (function(){
      const m=$('#buildMenu'), r=$('#buildReopen');
      m.addEventListener('dblclick', ()=>{ m.style.display='none'; r.style.display='block'; dockReopen(); });
      r.addEventListener('click', ()=>{ m.style.display='block'; r.style.display='none'; dockBuildMenu(); });
      function dockReopen(){ const hud=$('#hud'); const y=hud.offsetTop + hud.offsetHeight + 8; r.style.top = y+'px'; }
      window.addEventListener('resize', dockReopen);
    })();

    // =========================================================
    // DOCKING: Build-Menü exakt UNTER der Ressourcenleiste
    // =========================================================
    function dockBuildMenu(){
      const hud = $('#hud');
      const menu = $('#buildMenu');
      const y = hud.offsetTop + hud.offsetHeight + 8; // 8px Abstand
      menu.style.top = y+'px';
    }
    window.addEventListener('load', dockBuildMenu);
    window.addEventListener('resize', dockBuildMenu);
    const ro = new ResizeObserver(()=>dockBuildMenu()); ro.observe($('#hud'));

    // =========================================================
    // BUILD-TOOLS: Icons + „existiert dieses Tool?“ Prüfung
    // =========================================================
    const toolButtons = Array.from(document.querySelectorAll('#buildTools .tool, .group .tool'));
    toolButtons.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const tool = btn.dataset.tool;
        const ok = !!(window.Game && window.Game.buildCosts && window.Game.buildCosts[tool]);
        if(!ok){
          btn.classList.add('shake'); setTimeout(()=>btn.classList.remove('shake'), 280);
          BootUI.dbg('Build tool nicht verfügbar (noch nicht im Spiel hinterlegt):', tool);
          return;
        }
        toolButtons.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        window.Game?.setActiveTool?.(tool);
        BootUI.dbg('Tool', tool);
      });
    });

    // „Weiterspielen“
    BootUI.continueLastSnapshot = async function(){
      try{
        const raw=localStorage.getItem('lastSnapshot');
        if(!raw){ alert('Kein Spielstand gefunden.'); $('#startPanel').style.display='grid'; return; }
        const snap=JSON.parse(raw);
        await window.GameLoader.continueFrom(snap);
      }catch(e){
        alert('Konnte Spielstand nicht laden.');
        $('#startPanel').style.display='grid';
      }
    };

    // UI ready
    log('UI ready (v1.13, Road-Overlay-Render aktiv)');
  })();
  </script>
</body>
</html>
