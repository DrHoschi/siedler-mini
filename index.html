<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Siedler‑Mini</title>

  <!-- PWA/Styles (deine bestehenden Dateien bleiben unberührt) -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="style.css">

  <!-- Kleine, lokale Styles nur für Start-Panel/Canvas-Layer -->
  <style>
    :root{--bg:#0b1726;--panel:#0f1d31}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:#cfe3ff;font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto}

    /* Zeichenfläche: eigener Layer, damit UI nicht „mitzoomt“ */
    #stageWrap{position:fixed;inset:0;overflow:hidden;z-index:0}
    #stage{position:absolute;left:0;top:0}

    /* Start-Panel: zentriert, stets im Vordergrund */
    #startPanel{position:fixed;inset:0;display:grid;place-items:center;z-index:90000}
    #startPanel .card{
      background:var(--panel); border:1px solid #1e2d42; border-radius:16px; padding:18px;
      min-width:300px; max-width:min(92vw,600px); box-shadow:0 20px 60px rgba(0,0,0,.45)
    }
    #startPanel h1{margin:0 0 10px 0;font-size:40px;letter-spacing:.5px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
    select,button,input[type=checkbox]{font:inherit}
    button{background:#0f1b29;border:1px solid #1b2a40;color:#cfe3ff;border-radius:10px;padding:10px 14px;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .muted{opacity:.8}
    #quickDiag{white-space:pre; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>
<body>

  <!-- Zeichenfläche (UI bleibt separat) -->
  <div id="stageWrap">
    <canvas id="stage" width="1024" height="768"></canvas>
  </div>

  <!-- Start/Control-UI (zentriert) -->
  <div id="startPanel">
    <div class="card">
      <h1>Siedler‑Mini</h1>

      <div class="row">
        <label for="mapSelect">Karte:&nbsp;</label>
        <select id="mapSelect">
          <option value="assets/maps/map-demo.json">map-demo.json</option>
          <option value="assets/maps/map-pro.json">map-pro.json</option>
          <option value="assets/maps/map-test-all.json">map-test-all.json</option>
        </select>
      </div>

      <div class="row">
        <label class="muted"><input id="autoStart" type="checkbox"> Auto‑Start (nur einmal)</label>
      </div>

      <div class="row">
        <button id="btnStart">Start</button>
        <button id="btnReload">Neu laden</button>
        <button id="btnFull">Vollbild</button>
        <button id="btnDebug">Debug</button>
        <button id="btnSaveDbg">Debug speichern</button>
      </div>

      <!-- Sofort-Diagnose, damit du siehts, ob alles „grün“ ist -->
      <div class="row muted" id="quickDiag"></div>
    </div>
  </div>

  <!-- Debug/Inspector zuerst laden, damit console-Hooks früh aktiv sind -->
  <script src="debug.js"></script>
  <script src="tools/dev-inspector.js"></script>

  <!-- Deine Engine/Module in stabiler Reihenfolge (falls benötigt) -->
  <script src="boot.js"></script>
  <script src="app-v11.1r6.js"></script>
  <script src="main.js"></script>
  <script src="render.js"></script>
  <script src="textures.js"></script>
  <script src="world.js"></script>
  <script src="input.js"></script>
  <script src="unitLogic.js"></script>
  <script src="buildingData.js"></script>
  <script src="fullscreen.js"></script>

  <!-- WICHTIG: game.js nach den Modulen, damit GameLoader/Kamera bereitstehen -->
  <script src="game.js"></script>

  <!-- Page-Bootstrapping: Button-Wiring, Quick-Diag, (optionaler) Auto-Start -->
  <script>
  (function(){
    const $ = (id)=>document.getElementById(id);

    const btnStart   = $('btnStart');
    const btnReload  = $('btnReload');
    const btnFull    = $('btnFull');
    const btnDebug   = $('btnDebug');
    const btnSaveDbg = $('btnSaveDbg');
    const mapSelect  = $('mapSelect');
    const autoStart  = $('autoStart');
    const diag       = $('quickDiag');

    // Debounce/Busy-Guard
    let busy = false;

    async function doStart() {
      if (busy) return;
      busy = true; btnStart.disabled = true;
      try {
        const map = mapSelect.value;
        if (!window.GameLoader?.start) throw new Error('GameLoader.start fehlt');
        console.log('[boot] Start Game', map);
        await GameLoader.start(map); // Cache‑Bust & Guard passieren in game.js
      } catch (e) {
        console.error('[boot] GameStart fehlgeschlagen:', e);
        alert('GameStart fehlgeschlagen. Details in der Konsole.');
      } finally {
        busy = false; btnStart.disabled = false;
      }
    }

    async function doReload() {
      if (busy) return;
      busy = true; btnReload.disabled = true;
      try {
        const map = mapSelect.value;
        console.log('[boot] Reload Game', map);
        if (window.GameLoader?.reload) await GameLoader.reload(map);
        else if (window.GameLoader?.start) await GameLoader.start(map);
        else throw new Error('GameLoader.* fehlt');
      } catch (e) {
        console.error('[boot] Reload fehlgeschlagen:', e);
        alert('Reload fehlgeschlagen. Details in der Konsole.');
      } finally {
        busy = false; btnReload.disabled = false;
      }
    }

    // Button-Wiring
    btnStart .addEventListener('click', doStart);
    btnReload.addEventListener('click', doReload);
    btnFull  .addEventListener('click', () => {
      if (document.fullscreenElement) document.exitFullscreen();
      else document.documentElement.requestFullscreen?.();
    });
    btnDebug .addEventListener('click', () => {
      const di = document.getElementById('devInspector');
      if (!di) return;
      const min = di.classList.contains('min');
      window.DevInspector?.setMinimized(!min);
    });
    btnSaveDbg.addEventListener('click', () => {
      if (typeof window.saveDebugLog==='function') return window.saveDebugLog();
      // Fallback: aktuellen Inspector-Log exportieren (falls saveDebugLog fehlt)
      const txt = document.querySelector('#diLogPre')?.textContent || '';
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([txt], {type:'text/plain'}));
      a.download = 'siedler-mini-debug.txt';
      a.click(); URL.revokeObjectURL(a.href);
    });

    // Quick‑Diag: zeige wichtigsten Status im Start-Panel
    function diagLine(ok, label, extra='') {
      return `[${ok?'OK':'FAIL'}] ${label}${extra?(' • '+extra):''}`;
    }
    function paintDiag() {
      const lines = [];
      lines.push( diagLine(!!document.getElementById('stage'), 'Canvas #stage') );
      lines.push( diagLine(!!window.GameLoader && typeof GameLoader.start==='function', 'GameLoader.start') );
      lines.push( diagLine(!!window.GameCamera, 'GameCamera') );
      lines.push( diagLine(typeof window.saveDebugLog==='function', 'saveDebugLog()') );
      lines.push( diagLine(true, 'Map‑URL', mapSelect.value) );
      const sw = !!(navigator.serviceWorker && navigator.serviceWorker.controller);
      lines.push( diagLine(sw, 'ServiceWorker aktiv', sw?'Ja':'Nein') );
      diag.textContent = lines.join('\n');
    }
    paintDiag();

    // Optionaler Auto‑Start (nur 1×, falls Checkbox gesetzt)
    if (autoStart.checked) {
      // Wenn ein anderes Script (z. B. boot.js) ebenfalls autostartet,
      // verhindert der Reentrancy‑Guard in game.js Doppel‑Starts.
      setTimeout(doStart, 0);
    }

    console.log('[boot] UI bereit.');
  })();
  </script>
</body>
</html>
