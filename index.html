<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1628" />
  <title>Siedler-Mini V14.7 (Mobil)</title>

  <style>
    :root{
      color-scheme: dark;
      --bg:#0b1628; --panel:#122238; --panel2:#0f1d31;
      --line:#2b3b53; --text:#cfe3ff; --muted:#9fb3cc;
      --pill:#0f1b29; --ok:#1a7f3e; --warn:#982e2e;
      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --dbgHeight: 56px;
    }
    html,body{ height:100%; margin:0; background:var(--bg); }
    body{ overflow:hidden; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:var(--text); }

    .bg{
      position:fixed; inset:0; z-index:0;
      background:#0b1628 url('./assets/Logo.PNG') center center / cover no-repeat;
    }
    canvas{
      position:relative; z-index:1;
      display:block; width:100vw; height:100vh; background:transparent;
      image-rendering: pixelated; image-rendering: crisp-edges; touch-action:none;
    }

    .dbg{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      display:flex; gap:.5rem; align-items:center; padding:.5rem .75rem;
      height:var(--dbgHeight);
      background:linear-gradient(180deg, rgba(15,27,41,.75), rgba(15,27,41,.95));
      border-top:1px solid var(--line);
      backdrop-filter: blur(6px); box-shadow: var(--shadow);
    }
    .dbg .pill{
      background:var(--pill); border:1px solid var(--line);
      padding:.35rem .6rem; border-radius:10rem; font-size:.85rem; color:var(--text);
      user-select:none; cursor:pointer;
    }
    .dbg .pill[aria-pressed="true"]{ outline:2px solid #3b82f6; }
    .dbg .sep{ width:1px; height:1.75rem; background:var(--line); margin:0 .25rem; }
    .dbg .info{ font-size:.8rem; color:var(--muted); margin-left:auto; display:flex; gap:1rem; }

    .panel{
      position:fixed; right:.75rem; bottom:calc(var(--dbgHeight) + .75rem); z-index:19;
      min-width:220px; max-width:min(90vw, 380px);
      background:var(--panel); border:1px solid var(--line); border-radius:.6rem;
      box-shadow: var(--shadow); padding:.5rem .75rem; display:none;
    }
    .panel.show{ display:block; }
    .panel h3{ margin:.2rem 0 .6rem; font-size:1rem; font-weight:600; }
    .kv{ display:grid; grid-template-columns: auto 1fr; gap:.25rem .75rem; font-size:.85rem; }
    .kv .k{ color:var(--muted); } .kv .v{ color:var(--text); }

    .start-overlay{
      position:fixed; inset:0; z-index:30; display:none;
      align-items:flex-start; justify-content:center;
      padding-top:clamp(40px, 40vh, 55vh);
      background:linear-gradient(180deg, rgba(10,18,32,.55), rgba(10,18,32,.65));
      backdrop-filter: blur(8px);
    }
    .start-overlay.show{ display:flex; }
    .start-overlay .card{
      background:var(--panel2); border:1px solid var(--line);
      padding:1rem 1.25rem; border-radius:.8rem; box-shadow:var(--shadow);
      text-align:center; max-width:min(92vw, 460px);
    }
    .start-overlay .card h1{ margin:.2rem 0 .55rem; font-size:1.15rem; }
    .start-overlay .card p{ margin:.25rem 0 .75rem; color:var(--muted); }
    .start-overlay .row{ display:flex; gap:.5rem; justify-content:center; flex-wrap:wrap; }
    .start-overlay .btn{
      appearance:none; border:1px solid var(--line); background:var(--pill);
      color:var(--text); padding:.6rem .9rem; border-radius:.6rem; font-weight:600; cursor:pointer;
    }
    .start-overlay .btn.warn{ border-color:#7a2828; }
  </style>
</head>
<body>
  <div class="bg" aria-hidden="true"></div>

  <!-- Start-Fenster mit 4 Buttons -->
  <div class="start-overlay" id="start" data-autostart="0">
    <div class="card">
      <h1>Siedler-Mini</h1>
      <p>Willkommen! Bitte w√§hlen:</p>
      <div class="row">
        <button class="btn" id="btnStart">Start</button>
        <button class="btn" id="btnLoad">Laden</button>
        <button class="btn warn" id="btnReset">Reset</button>
        <button class="btn" id="btnFullscreen">Vollbild</button>
      </div>
    </div>
  </div>

  <canvas id="game"></canvas>

  <!-- Debug-Info -->
  <div class="panel" id="pInfo" aria-hidden="true">
    <h3>Infos</h3>
    <div class="kv">
      <div class="k">DPR</div><div class="v" id="vDpr">‚Äì</div>
      <div class="k">Viewport</div><div class="v" id="vVp">‚Äì</div>
      <div class="k">Canvas</div><div class="v" id="vCv">‚Äì</div>
      <div class="k">Boot</div><div class="v">./boot.js</div>
    </div>
  </div>

  <!-- Debug-Bar -->
  <div class="dbg">
    <button class="pill" id="tglInfo" aria-pressed="false">‚ÑπÔ∏è Infos</button>
    <button class="pill" id="tglLayers" aria-pressed="false">üó∫Ô∏è Overlays</button>
    <span class="sep"></span>
    <button class="pill" id="btnReload">‚ü≥ Reload</button>
    <button class="pill" id="btnCenter">üéØ Zentrum</button>
    <span class="sep"></span>
    <div class="info">
      <span id="lblFps">FPS: ‚Äì</span>
      <span id="lblHint">Startfenster zuerst</span>
    </div>
  </div>

  <script type="module">
    import { Assets } from './core/asset.js';
    import { SiedlerMap } from './tools/map-runtime.js';

    const cv = document.getElementById('game');
    const ctx = cv.getContext('2d', { alpha:false });
    const start = document.getElementById('start');
    const btnStart = document.getElementById('btnStart');
    const btnLoad = document.getElementById('btnLoad');
    const btnReset = document.getElementById('btnReset');
    const btnFullscreen = document.getElementById('btnFullscreen');

    const vDpr = document.getElementById('vDpr');
    const vVp = document.getElementById('vVp');
    const vCv = document.getElementById('vCv');

    function resize(){
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      const w = innerWidth, h = innerHeight;
      cv.width = w * dpr; cv.height = h * dpr;
      cv.style.width = w+'px'; cv.style.height = h+'px';
      ctx.setTransform(dpr,0,0,dpr,0,0);
      vDpr.textContent = dpr.toFixed(2);
      vVp.textContent = `${w}√ó${h}`; vCv.textContent = `${cv.width}√ó${cv.height}`;
    }
    addEventListener('resize', resize);
    Assets.imageRenderingCrisp(cv); resize();

    let world=null, started=false;
    async function begin(){
      if (started) return; started=true;
      await Assets.loadAll({
        images:['./assets/tiles/tileset.png'],
        json:['./assets/tiles/tileset.json','./assets/maps/map-pro.json']
      });
      const worldJson = await Assets.get('./assets/maps/map-pro.json');
      world = new SiedlerMap({
        tileResolver:(n)=>'./assets/'+n,
        onReady:()=>loop()
      });
      await world.loadFromObject(worldJson);
    }

    function loop(){
      ctx.clearRect(0,0,cv.width,cv.height);
      if (world) world.draw(ctx,{x:0,y:0,w:cv.width,h:cv.height});
      requestAnimationFrame(loop);
    }

    // Buttons
    btnStart.addEventListener('click',()=>{ start.classList.remove('show'); begin(); });
    btnLoad.addEventListener('click',()=>alert('Laden: Funktion kommt sp√§ter.'));
    btnReset.addEventListener('click',()=>location.reload());
    btnFullscreen.addEventListener('click',()=>{
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else document.exitFullscreen();
    });

    // Startfenster immer zeigen
    start.classList.add('show');
  </script>
</body>
</html>
