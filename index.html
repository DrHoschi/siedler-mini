<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1628" />
  <title>Siedler-Mini V14.7 (Mobil)</title>

  <!-- =====================================================================
       Basis-Styles (Canvas + HUD). Mobil-Spezifika werden in mobile.css/ios.css überschrieben.
       Design-Farben bleiben so, wie von dir gewünscht.
       ===================================================================== -->
  <style>
    :root {
      color-scheme: dark;
      --bg:#0b1628; --panel:#122238; --panel2:#0f1d31;
      --line:#2b3b53; --text:#cfe3ff; --muted:#9fb3cc;
      --pill:#0f1b29; --ok:#1a7f3e; --warn:#982e2e;
      --shadow: 0 20px 60px rgba(0,0,0,.35);
    }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); }
    body{ display:flex; flex-direction:column; align-items:center; justify-content:center; }
    canvas{ display:block; max-width:100%; max-height:100%; background:var(--bg); }
    #startScreen{
      position:absolute; inset:0; display:flex;
      align-items:center; justify-content:center;
      background:rgba(11,22,40,0.95); color:var(--text);
      font-family:sans-serif; z-index:10;
    }
    #startScreen button{
      padding:1em 2em; font-size:1.2em;
      background:var(--panel); border:1px solid var(--line);
      color:var(--text); border-radius:4px; cursor:pointer;
    }
    #dbgOverlay{
      position:absolute; top:0; left:0; right:0; max-height:40%;
      overflow:auto; background:rgba(0,0,0,0.7); font-family:monospace;
      font-size:12px; color:#fff; padding:4px; display:none; z-index:20;
    }
  </style>
</head>
<body>
  <!-- Start-Screen -->
  <div id="startScreen">
    <button id="btnStart">Start</button>
  </div>
  <!-- Debug-Overlay -->
  <div id="dbgOverlay"></div>
  <!-- Haupt-Canvas -->
  <canvas id="gameCanvas"></canvas>

  <!-- =====================================================================
       Debug-Overlay-Script: sorgt dafür, dass wir im Spiel jederzeit Logs sehen.
       ===================================================================== -->
  <script>
    const dbgOverlayEl = document.getElementById('dbgOverlay');
    function dbgOverlay(msg){
      try{
        dbgOverlayEl.style.display='block';
        dbgOverlayEl.insertAdjacentHTML('beforeend',
          `<div>${new Date().toLocaleTimeString()} :: ${msg}</div>`);
      }catch(e){ console.warn('dbgOverlay fail', e); }
    }
    window.dbgOverlay = dbgOverlay;

    // Toggle mit Taste "D"
    window.addEventListener('keydown', ev=>{
      if(ev.key==='d' || ev.key==='D'){
        dbgOverlayEl.style.display = dbgOverlayEl.style.display==='none'?'block':'none';
      }
    });
  </script>

  <!-- =====================================================================
       Patch A: NET-LOGGER
       Dieser Block loggt JEDEN fetch()-Aufruf ins Debug-Overlay.
       Damit sehen wir sofort, welche URL geladen wurde und ob es Fehler (404 etc.) gab.
       ===================================================================== -->
  <script>
  (function(){
    const origFetch = window.fetch;
    window.fetch = async function(...args){
      const url = String(args[0]);
      const t0 = performance.now();
      try{
        const res = await origFetch.apply(this, args);
        const ms = (performance.now()-t0).toFixed(0);
        console.info('[net]', res.status, url, ms+'ms');
        try{
          const box=document.getElementById('dbgOverlay');
          const panel=box;
          if(panel){ box.style.display='block';
            panel.insertAdjacentHTML('beforeend', `<div><b>[net]</b> ${res.status} ${url} (${ms}ms)</div>`);
          }
        }catch{}
        return res;
      }catch(err){
        console.error('[net-error]', url, err);
        try{
          const box=document.getElementById('dbgOverlay');
          const panel=box;
          if(panel){ box.style.display='block';
            panel.insertAdjacentHTML('beforeend', `<div><b>[net-error]</b> ${url}<pre>${err && (err.stack||err.message||String(err))}</pre></div>`);
          }
        }catch{}
        throw err;
      }
    };
  })();
  </script>

  <!-- =====================================================================
       Haupt-Import-Script (Module). Lädt boot.js, game.js usw.
       Enthält Cache-Busting, damit immer die aktuelle Version genommen wird.
       ===================================================================== -->
  <script type="module">
    // Cache-Busting Query-Parameter (zwingt Browser, frische Datei zu laden)
    const BUST = `?v=${Date.now()}`;

    async function tryImport(path){
      try{ return await import(path + BUST); }
      catch(err){
        const msg = `${err && (err.name||'Error')}: ${err && (err.message||String(err))}`;
        console.error(`Import fehlgeschlagen: ${path}`, err);
        try{
          const box=document.getElementById('dbgOverlay');
          const panel=box;
          if(panel){ box.style.display='block';
            panel.insertAdjacentHTML('beforeend', `<div><b>[import]</b> ${path}<pre>${msg}</pre></div>`);
          }
        }catch{}
        return null;
      }
    }

    // Lade Module
    const M_asset = await tryImport('./core/asset.js');
    const M_tools = await tryImport('./tools/map-runtime.js');
    const M_boot  = await tryImport('./boot.js');
    const M_game  = await tryImport('./game.js');

    // Starte Spiel, sobald Button geklickt
    document.getElementById('btnStart').addEventListener('click', ()=>{
      document.getElementById('startScreen').style.display='none';
      if(M_boot && M_boot.startGame){
        M_boot.startGame({M_asset,M_tools,M_game});
      }else{
        dbgOverlay('Start fehlgeschlagen: boot.js nicht geladen.');
      }
    });
  </script>
</body>
</html>
