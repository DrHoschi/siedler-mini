<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Siedler Mini – Prototype</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#12161c" />

  <!-- ============================================================
       index.html • v1.20
       Fixes:
       - BootUI Logger VOR game.js/boot.js geladen ⇒ frühe Logs sichtbar
       - Fetch-Trace (nur Logging, kein Verhalten geändert)
       - Start / Editor / Cache-Leeren bleiben funktionsfähig
       ============================================================ -->

  <style>
    :root{
      --glass:rgba(16,23,34,.65);
      --text:#e8eef6; --muted:#9fb0c8; --accent:#3b82f6;
      --danger:#ef4444; --radius:14px; --blur:10px;
      --ok:#22c55e; --warn:#eab308; --err:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#0b0f14;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    button{cursor:pointer}
    .btn{background:#1f2a3a;border:1px solid #ffffff1a;color:#e9eef7;padding:10px 14px;border-radius:12px;font-weight:600;display:inline-flex;gap:8px;align-items:center}
    .btn.primary{background:#2a3b55;border-color:#3b82f650}
    .btn.danger{background:#3a2226;border-color:#ef444450}

    #stage{position:fixed;inset:0;display:block;touch-action:none;background:#0b120b}
    #backdrop{position:fixed;inset:0;background:#000 url("./assets/Logo.PNG") center/contain no-repeat;opacity:.9;transition:opacity .5s;pointer-events:none;z-index:5}

    /* Startpanel */
    #startPanel{position:fixed;inset:0;display:grid;place-items:center;z-index:20;background:rgba(0,0,0,.55);backdrop-filter: blur(6px)}
    #startCard{width:min(680px,92vw);padding:20px;border-radius:18px;background:#12161ccc;border:1px solid #ffffff10}

    /* Ressourcen-Toast oben */
    #hudToast{
      position:fixed; left:10px; right:10px; top:10px; z-index:12;
      display:flex; gap:16px; align-items:center;
      padding:10px 12px; border-radius:16px; background:var(--glass);
      backdrop-filter:blur(var(--blur)); border:1px solid #ffffff14;
      overflow:auto; -webkit-overflow-scrolling:touch;
    }
    .ico{width:18px;height:18px;opacity:.95;vertical-align:-3px}
    .resItem{display:flex;align-items:center;gap:8px;padding:6px 10px;background:#0d1422;border-radius:12px;border:1px solid #ffffff10;white-space:nowrap}
    .resVal{min-width:32px;text-align:right}

    /* Baumenü kompakt */
    #buildMenu{
      position:fixed; left:10px; right:10px; z-index:12;
      background:var(--glass); backdrop-filter:blur(var(--blur));
      border:1px solid #ffffff19; border-radius:16px; padding:8px;
      top: calc(10px + 54px + 10px);
    }
    #bmHead{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    #bmTitle{font-weight:800}
    #bmClose{margin-left:auto;border-radius:999px;width:34px;height:34px;display:grid;place-items:center;background:#2a3347;border:1px solid #ffffff22}
    #bmCats, #bmRow{
      display:flex; gap:8px; overflow-x:auto; overflow-y:hidden; padding:6px 4px 8px;
      -webkit-overflow-scrolling:touch; scrollbar-width:thin;
    }
    .cat{flex:0 0 auto; padding:8px 12px;border-radius:999px;border:1px solid #ffffff1f;background:#162034;color:#d7dfed;font-weight:700}
    .cat.active{outline:2px solid var(--accent)}
    .bcard{
      flex:0 0 auto; width:92px; border-radius:12px; border:1px solid #ffffff1a;
      background:#182233; display:flex; flex-direction:column; align-items:center;
      padding:8px 6px; gap:6px
    }
    .thumb{width:64px;height:64px;object-fit:contain;border-radius:6px;background:#0c1422;border:1px solid #ffffff10}
    .label{font-size:.78rem;line-height:1.2;text-align:center;color:#d7dfed;min-height:2.2em}
    .bcard.active{outline:2px solid var(--accent)}
    .bcard.disabled{opacity:.5;filter:saturate(.6)}

    /* Reopen-Button (Werkzeug) */
    #buildOpen{
      position:fixed; left:10px; bottom:82px; z-index:13;
      width:44px; height:44px; border-radius:999px; border:1px solid #ffffff22;
      background:var(--glass); backdrop-filter:blur(var(--blur));
      display:none; align-items:center; justify-content:center; font-size:20px;
    }

    /* Toast unten */
    #toast{
      position:fixed; left:10px; right:10px; bottom:10px; z-index:30;
      display:flex; gap:12px; justify-content:space-between; align-items:center;
      padding:10px 12px; border-radius:16px; background:var(--glass);
      backdrop-filter:blur(var(--blur)); border:1px solid #ffffff14
    }
    #verSmall{font-size:.78rem;color:var(--muted)}

    /* Inspector */
    #inspector{
      position:fixed;left:10px;right:10px;bottom:70px;z-index:28;display:none;
      background:#1a2230;border:1px solid #ffffff14;border-radius:16px;padding:12px;
      max-height:32vh; overflow:hidden;
    }
    #inspector.max{top:10px; bottom:70px; max-height:none;}
    #logToolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
    #logTabs button{padding:8px 12px;border-radius:999px;border:1px solid #ffffff22;background:#162034;color:#d7dfed}
    #logTabs button.active{outline:2px solid var(--accent)}
    #logFilter{padding:8px 10px;border-radius:10px;background:#0d1422;color:#e9eef7;border:1px solid #ffffff22}
    #log{height:100%;max-height:28vh;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;line-height:1.3;background:#0d121a;border-radius:10px;padding:10px;border:1px solid #ffffff10;white-space:pre-wrap}
    .logline{margin:2px 0}
    .log-ok::before{content:"✅ ";color:var(--ok)}
    .log-warn::before{content:"⚠️ ";color:var(--warn)}
    .log-err::before{content:"❌ ";color:var(--err)}
    .ts{opacity:.7}
    .src{opacity:.8}

    /* Editor Panel */
    #editorPanel{
      position:fixed; inset:10px 10px 70px 10px; z-index:26; display:none;
      background:#111824; border:1px solid #ffffff22; border-radius:16px; padding:12px;
      backdrop-filter: blur(6px);
    }
    #editorHead{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    #editorTitle{font-weight:800}
    #editorClose{margin-left:auto} 
    #editorBody{height:100%;min-height:200px;border:1px dashed #ffffff22;border-radius:12px;padding:10px;overflow:auto}
    #editorHint{color:#9fb0c8;margin-bottom:6px}
    pre.code{background:#0b1018;border:1px solid #ffffff12;border-radius:10px;padding:10px;overflow:auto}
    
    /* Vollbild */
    #fsEnter,#fsExit{position:fixed;right:10px;top:10px;z-index:14;border-radius:12px;border:1px solid #ffffff14;background:var(--glass);backdrop-filter:blur(var(--blur));padding:8px 10px}
    #fsExit{display:none}
  </style>

  <!-- ================== BootUI LOGGER & FETCH-TRACE (früh!) ================== -->
  <script>
  (function(){
    // Früher Logger — damit game.js/boot.js sofort loggen können
    const BootUI = (window.BootUI = window.BootUI || {});
    const logs = { game: [], editor: [] }; // {ts,lvl,text,src}
    function tsStr(d){ return d.toTimeString().slice(0,8); }
    function push(src,lvl,args){
      const text = Array.from(args).map(a=>{ try{ return (typeof a==='string')?a:JSON.stringify(a); }catch{ return String(a); } }).join(' ');
      const e = { ts:new Date(), lvl, text, src }; logs[src].push(e);
      // Spiegel in Konsole:
      const tag = (lvl==='err')?'error':(lvl==='warn'?'warn':'log');
      console[tag](`[${tsStr(e.ts)}] (${src}) ${text}`);
      // Falls UI schon existiert, nachtragen:
      try{
        if(window.__renderLogNow) window.__renderLogNow();
      }catch{}
    }
    BootUI.__logs = logs;
    BootUI.logOK=(...a)=>push('game','ok',a);
    BootUI.logWarn=(...a)=>push('game','warn',a);
    BootUI.logErr=(...a)=>push('game','err',a);
    BootUI.edOK=(...a)=>push('editor','ok',a);
    BootUI.edWarn=(...a)=>push('editor','warn',a);
    BootUI.edErr=(...a)=>push('editor','err',a);
    BootUI.dbg=(...a)=>BootUI.logOK(...a); // Alias

    // Fetch-Trace (nur Logging, Verhalten unverändert)
    const origFetch = window.fetch.bind(window);
    window.fetch = async function(input, init){
      const url = (typeof input==='string')?input:(input && input.url)||'';
      BootUI.logOK('fetch', url || '(req)');
      try{
        const res = await origFetch(input, init);
        // Map-/Asset-Erkennung (heuristisch): json/png/jpg
        const ok = res.ok ? 'ok' : 'warn';
        BootUI[ ok==='ok' ? 'logOK' : 'logWarn' ]('fetch-res', res.status, res.statusText, url);
        return res;
      }catch(e){
        BootUI.logErr('fetch-fail', (e && e.message)||String(e), url);
        throw e;
      }
    };
  })();
  </script>
  <!-- ======================================================================== -->
</head>
<body>

  <canvas id="stage"></canvas>
  <div id="backdrop" aria-hidden="true"></div>

  <!-- Start -->
  <div id="startPanel" role="dialog" aria-modal="true">
    <div id="startCard">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:800;font-size:1.1rem">Siedler Mini</div>
        <div style="opacity:.7">Build <span id="buildDate"></span></div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
        <select id="mapSelect" class="btn" style="flex:1;background:#1b2433">
          <option value="./assets/maps/map-mini.json" selected>Mini-Map (Test)</option>
          <option value="./assets/maps/map-demo.json">Demo</option>
          <option value="./assets/maps/map-test-all.json">Test-All</option>
          <option value="./assets/maps/map-pro.json">Pro</option>
        </select>
        <button id="btnNew" class="btn primary">Neues Spiel</button>
        <button id="btnCont" class="btn">Weiterspielen</button>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <button id="btnReset" class="btn danger">Reset</button>
        <div style="flex:1"></div>
        <span style="color:#9fb0c8">Vollbild oben rechts.</span>
      </div>
    </div>
  </div>

  <!-- Ressourcen-Toast -->
  <div id="hudToast" aria-live="polite" aria-atomic="true">
    <div class="resItem"><svg class="ico" viewBox="0 0 24 24"><path fill="currentColor" d="M7 3l10 4-4 10-10-4z"/></svg> Holz <span class="resVal" id="res-wood">0</span></div>
    <div class="resItem"><svg class="ico" viewBox="0 0 24 24"><path fill="currentColor" d="M4 16l4-10h8l4 10-8 5z"/></svg> Stein <span class="resVal" id="res-stone">0</span></div>
    <div class="resItem"><svg class="ico" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4" fill="currentColor"/><path d="M4 20c2-4 14-4 16 0" fill="currentColor"/></svg> Nahrung <span class="resVal" id="res-food">0</span></div>
    <div class="resItem"><svg class="ico" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12a4 4 0 110-8 4 4 0 010 8zm-7 9a7 7 0 0114 0"/></svg> Bew. <span class="resVal" id="res-pop">0</span></div>
  </div>

  <!-- Baumenü -->
  <div id="buildMenu">
    <div id="bmHead">
      <div id="bmTitle">Baumenü</div>
      <button id="bmClose" title="Menü schließen">✕</button>
    </div>
    <div id="bmCats">
      <button class="cat active" data-cat="infra">Infrastruktur</button>
      <button class="cat" data-cat="raw">Rohstoffe</button>
      <button class="cat" data-cat="food">Nahrung</button>
      <button class="cat" data-cat="storage">Lager</button>
      <button class="cat" data-cat="housing">Wohnen/HQ</button>
    </div>
    <div id="bmRow"></div>
  </div>

  <!-- Reopen (Werkzeug) -->
  <button id="buildOpen" title="Baumenü öffnen">🛠️</button>

  <!-- Vollbild -->
  <button id="fsEnter" title="Vollbild">⛶</button>
  <button id="fsExit"  title="Vollbild verlassen">✕</button>

  <!-- Toast unten -->
  <div id="toast">
    <div class="left" style="display:flex;gap:8px">
      <button id="btnMenu" class="btn">Menü</button>
      <button id="btnEditor" class="btn">Editor öffnen</button>
    </div>
    <div class="right" style="display:flex;gap:10px;align-items:center">
      <button id="btnInspector" class="btn">Inspector</button>
      <button id="btnCache" class="btn">Cache leeren</button>
      <span id="verSmall">V?.?.? • <span id="versionDate"></span></span>
    </div>
  </div>

  <!-- Inspector -->
  <div id="inspector" aria-label="Debugger">
    <div id="logToolbar">
      <div id="logTabs">
        <button id="tabGame" class="active">Spiel‑Log</button>
        <button id="tabEditor">Editor‑Log</button>
      </div>
      <select id="logFilter" title="Filter">
        <option value="all">Alle</option>
        <option value="ok">OK</option>
        <option value="warn">Warnung</option>
        <option value="err">Fehler</option>
      </select>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="btnLogMax" class="btn">Max</button>
        <button id="btnCopyPaths" class="btn">Copy Pfad‑Liste</button>
        <button id="btnExportJson" class="btn">Export JSON</button>
        <button id="btnCloseInspector" class="btn">Close</button>
      </div>
    </div>
    <div id="log"></div>
  </div>

  <!-- Level-Editor Panel -->
  <div id="editorPanel" aria-label="Level-Editor">
    <div id="editorHead">
      <div id="editorTitle">Level‑Editor</div>
      <div id="editorHint">Hier kommt dein Editor‑UI hin. (Hook ist verdrahtet.)</div>
      <button id="editorClose" class="btn">Schließen</button>
    </div>
    <div id="editorBody">
      <pre class="code">// Beispiel: window.Editor.setMap(...); window.Editor.export();</pre>
    </div>
  </div>

  <!-- Mini Asset-Loader -->
  <script>
  window.Asset = window.Asset || (function(){
    const cache = new Map(); let texturesReady=false;
    async function loadImage(key, url){
      if(cache.has(url)) return cache.get(url);
      return new Promise((res,rej)=>{
        const img=new Image(); img.crossOrigin="anonymous";
        img.onload=()=>{ cache.set(url,img); res(img); };
        img.onerror=()=>rej(new Error('IMG '+url)); img.src=url;
      });
    }
    return { loadImage, markTexturesReady(v){texturesReady=!!v;}, areTexturesReady(){return texturesReady;}, _cache:cache };
  })();
  </script>

  <!-- Lade SPIELCODE (kann BootUI sofort nutzen) -->
  <script src="./game.js"></script>
  <script src="./boot.js"></script>

  <!-- UI, Inspector & Hooks -->
  <script>
  (function(){
    const $ = (s)=>document.querySelector(s);
    const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
    const BootUI = window.BootUI;

    // ==== Inspector-UI an BootUI Logs anbinden ====
    const logBox = $('#log');
    function tsStr(d){ return d.toTimeString().slice(0,8); }
    function lineHtml(e){
      const css = e.lvl==='err'?'log-err':(e.lvl==='warn'?'log-warn':'log-ok');
      return `<div class="logline ${css}"><span class="ts">[${tsStr(e.ts)}]</span> <span class="src">(${e.src})</span> ${e.text}</div>`;
    }
    window.__renderLogNow = function(){
      const tab = (document.body.dataset.logTab || 'game');
      const filter = $('#logFilter').value || 'all';
      const arr = (BootUI.__logs?.[tab]) || [];
      logBox.innerHTML = arr
        .filter(e=> filter==='all' || e.lvl===filter)
        .map(lineHtml)
        .join('');
      logBox.scrollTop = logBox.scrollHeight;
    };

    // Versionsdatum
    const today=new Date(), y=today.getFullYear(), m=String(today.getMonth()+1).padStart(2,'0'), d=String(today.getDate()).padStart(2,'0');
    $('#buildDate').textContent=`${y}${m}${d}`;
    $('#versionDate').textContent=`${y}${m}${d}`;

    // Startpanel + Buttons
    function hideStart(){ $('#startPanel').style.display='none'; }
    function showStart(){ $('#startPanel').style.display='grid'; }
    $('#btnNew').addEventListener('click', async ()=>{
      const map = $('#mapSelect').value || './assets/maps/map-mini.json';
      if(confirm('Neues Spiel starten? Bestehende Spielstände können überschrieben werden.')){
        hideStart();
        try{
          BootUI.logOK('NewGame start', map);
          await window.GameLoader.start(map);
          BootUI.logOK('Game started');
        }catch(e){
          BootUI.logErr('Map LOAD FAIL', (e && e.message) || String(e));
          alert('Karte konnte nicht geladen werden. Öffne Startmenü erneut.');
          showStart();
        } finally { window.__renderLogNow(); }
      }
    });
    $('#btnCont').addEventListener('click', async ()=>{ hideStart(); BootUI.continueLastSnapshot?.(); });
    $('#btnReset').addEventListener('click', ()=>{ if(confirm('Wirklich alle Spielstände löschen?')){ try{localStorage.clear(); location.reload();}catch{} }});
    $('#btnMenu').addEventListener('click', showStart);

    // Backdrop Fade (ready/timeout)
    (function(){ const bd=$('#backdrop'); let t=setTimeout(()=>{BootUI.logWarn('Textures TIMEOUT → fade');bd.style.opacity='0';setTimeout(()=>bd.style.display='none',1200)},60000);
      const tick=()=>{ if(window.Asset?.areTexturesReady?.()){clearTimeout(t);bd.style.opacity='0';setTimeout(()=>{bd.style.display='none';BootUI.logOK('Backdrop hidden')},3000)} else requestAnimationFrame(tick) }; tick();
    })();

    // Inspector
    document.body.dataset.logTab='game';
    $('#btnInspector').addEventListener('click', ()=> { $('#inspector').style.display='block'; window.__renderLogNow(); });
    $('#btnCloseInspector').addEventListener('click', ()=> { $('#inspector').style.display='none'; });
    $('#btnLogMax').addEventListener('click', ()=>{
      const i=$('#inspector'); i.classList.toggle('max');
      $('#btnLogMax').textContent = i.classList.contains('max') ? 'Min' : 'Max';
    });
    $('#tabGame').addEventListener('click', ()=>{ document.body.dataset.logTab='game'; $('#tabGame').classList.add('active'); $('#tabEditor').classList.remove('active'); window.__renderLogNow(); });
    $('#tabEditor').addEventListener('click', ()=>{ document.body.dataset.logTab='editor'; $('#tabEditor').classList.add('active'); $('#tabGame').classList.remove('active'); window.__renderLogNow(); });
    $('#logFilter').addEventListener('change', window.__renderLogNow);

    // Aggressives Cache-Leeren
    async function clearCachesAndReload(){
      BootUI.logWarn('Cache clear requested');
      try{ localStorage.clear(); }catch{}
      try{ sessionStorage.clear(); }catch{}
      try{
        if('caches' in window){
          const names = await caches.keys();
          await Promise.all(names.map(n=>caches.delete(n)));
        }
      }catch(e){ BootUI.logWarn('Cache API failed', String(e)); }
      try{
        if('serviceWorker' in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r=>r.unregister()));
        }
      }catch(e){ BootUI.logWarn('SW unregister failed', String(e)); }
      location.replace(location.href.split('#')[0]);
    }
    $('#btnCache').addEventListener('click', ()=>{ if(confirm('Cache wirklich leeren?')) clearCachesAndReload(); });

    // Baumenü (Kategorien + Row)
    const bm=$('#buildMenu'), row=$('#bmRow');
    function svgThumb(kind){
      if(kind==='road') return '<svg class="thumb" viewBox="0 0 64 64"><rect x="28" y="0" width="8" height="64" fill="#d9dde6"/><rect x="0" y="28" width="64" height="8" fill="#d9dde6"/></svg>';
      if(kind==='hut')  return '<svg class="thumb" viewBox="0 0 64 64"><path d="M8 36L32 18l24 18v20H8z" fill="#b88a5a"/></svg>';
      return '<div class="thumb"></div>';
    }
    const BUILD_CARDS = [
      {tool:'road',cat:'infra',label:'Straße',thumbSVG:'road'},
      {tool:'hut',cat:'infra',label:'Hütte',thumbSVG:'hut'},
      {tool:'lumberjack_wood',cat:'raw',label:'Holzhütte',thumb:'./assets/tex/building/wood/lumberjack_wood.PNG'},
      {tool:'stonebraker_wood',cat:'raw',label:'Steinbrecher',thumb:'./assets/tex/building/wood/stonebraker_wood.PNG'},
      {tool:'farm_wood',cat:'food',label:'Farm',thumb:'./assets/tex/building/wood/farm_wood.PNG'},
      {tool:'baeckerei_wood',cat:'food',label:'Bäckerei',thumb:'./assets/tex/building/wood/baeckerei_wood.PNG'},
      {tool:'fischer_wood1',cat:'food',label:'Fischer',thumb:'./assets/tex/building/wood/fischer_wood1.PNG'},
      {tool:'wassermuehle_wood',cat:'food',label:'Wassermühle',thumb:'./assets/tex/building/wood/wassermuehle_wood.PNG'},
      {tool:'windmuehle_wood',cat:'food',label:'Windmühle',thumb:'./assets/tex/building/wood/windmuehle_wood.PNG'},
      {tool:'depot_wood',cat:'storage',label:'Depot',thumb:'./assets/tex/building/wood/depot_wood.PNG'},
      {tool:'depot_wood_ug',cat:'storage',label:'Depot UG',thumb:'./assets/tex/building/wood/depot_wood_ug.PNG'},
      {tool:'hq_wood',cat:'housing',label:'HQ',thumb:'./assets/tex/building/wood/hq_wood.PNG'},
      {tool:'hq_wood_ug1',cat:'housing',label:'HQ UG1',thumb:'./assets/tex/building/wood/hq_wood_ug1.PNG'},
      {tool:'haeuser_wood1',cat:'housing',label:'Haus 1',thumb:'./assets/tex/building/wood/haeuser_wood1.PNG'},
      {tool:'haeuser_wood1_ug1',cat:'housing',label:'Haus 1 UG1',thumb:'./assets/tex/building/wood/haeuser_wood_ug1.PNG'},
      {tool:'haeuser_wood2',cat:'housing',label:'Haus 2',thumb:'./assets/tex/building/wood/haeuser_wood2.PNG'},
    ];
    function renderCards(category){
      row.innerHTML='';
      BUILD_CARDS.filter(c=>c.cat===category).forEach(c=>{
        const btn=document.createElement('button');
        btn.className='bcard'; btn.dataset.tool=c.tool; btn.title=c.label;
        btn.innerHTML = c.thumb ? `<img class="thumb" src="${c.thumb}" alt="">` : svgThumb(c.thumbSVG);
        const cap=document.createElement('div'); cap.className='label'; cap.textContent=c.label; btn.appendChild(cap);
        btn.addEventListener('click', ()=>{
          const ok = !!(window.Game && window.Game.buildCosts && window.Game.buildCosts[c.tool]);
          if(!ok){ btn.classList.add('disabled'); BootUI.logWarn('Build-Tool nicht verfügbar:', c.tool); return; }
          $$('#bmRow .bcard').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
          window.Game?.setActiveTool?.(c.tool); BootUI.logOK('Tool', c.tool);
        });
        row.appendChild(btn);
      });
    }
    $$('#bmCats .cat').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $$('#bmCats .cat').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active'); renderCards(btn.dataset.cat);
      });
    });
    renderCards('infra');
    $('#bmClose').addEventListener('click', ()=>{ bm.style.display='none'; $('#buildOpen').style.display='flex'; });
    $('#buildOpen').addEventListener('click', ()=>{ bm.style.display='block'; $('#buildOpen').style.display='none'; });

    // Editor Hook
    const Editor = (window.Editor = window.Editor || {});
    const $panel = $('#editorPanel');
    Editor.open = function(){ $panel.style.display='block'; BootUI.edOK('Editor geöffnet'); window.__renderLogNow(); };
    Editor.close = function(){ $panel.style.display='none'; BootUI.edOK('Editor geschlossen'); window.__renderLogNow(); };
    Editor.toggle = function(){ ($panel.style.display==='block') ? Editor.close() : Editor.open(); };
    $('#btnEditor').addEventListener('click', ()=>{
      document.body.dataset.logTab='editor';
      $('#tabEditor').classList.add('active'); $('#tabGame').classList.remove('active');
      $('#inspector').style.display='block'; window.__renderLogNow(); Editor.open();
    });
    $('#editorClose').addEventListener('click', ()=> Editor.close());

    BootUI.logOK('UI ready (index v1.20)');
    // Erste Sicht im Inspector aktualisieren (falls geöffnet wird)
    window.__renderLogNow();
  })();
  </script>
</body>
</html>
