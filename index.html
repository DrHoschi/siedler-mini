<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1628" />
  <title>Siedler‚ÄëMini V14.7 (Mobil)</title>

  <!--
    Layout-Ziele:
    - Start-BG sichtbar ‚Üí nach Klick sauber ausblenden + deaktivieren (pointer + display:none)
    - Ressourcen-HUD oben angedockt
    - Bau-Men√º Panel mit Close-"X" rechts oben; X nur in Fullscreen sichtbar
    - Debug-Bar unten unver√§ndert
  -->
  <style>
    :root{
      color-scheme: dark;
      --bg:#0b1628; --panel:#122238; --panel2:#0f1d31;
      --line:#2b3b53; --text:#cfe3ff; --muted:#9fb3cc;
      --pill:#0f1b29; --ok:#1a7f3e; --warn:#982e2e;
      --accent:#3b82f6;
      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --dbgHeight: 56px;
      --hudHeight: 52px;
    }
    html,body{ height:100%; margin:0; background:var(--bg); }
    body{
      overflow:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:var(--text);
    }

    /* Vollfl√§chiges Start-Hintergrundbild */
    .bg{
      position:fixed; inset:0; z-index:0;
      background:#0b1628 url('./assets/Logo.PNG') center center / cover no-repeat;
      transition: opacity .35s ease;
    }
    .bg.fade{ opacity:0; pointer-events:none; }
    .bg.hidden{ display:none; } /* wird nach der Transition gesetzt (ressourcensparend) */

    /* Spielfl√§che */
    canvas{
      position:relative; z-index:1;
      display:block; width:100vw; height:100vh; background:transparent;
      image-rendering: pixelated; image-rendering: crisp-edges; touch-action:none;
    }

    /* HUD: Ressourcen oben */
    .hud{
      position:fixed; left:0; right:0; top:0; z-index:15;
      height:var(--hudHeight);
      display:flex; align-items:center; gap:.5rem;
      padding:.4rem .65rem;
      background:linear-gradient(180deg, rgba(18,34,56,.85), rgba(18,34,56,.65));
      border-bottom:1px solid var(--line);
      backdrop-filter: blur(6px);
      box-shadow: var(--shadow);
    }
    .hud .res{
      display:flex; align-items:center; gap:.4rem;
      padding:.3rem .55rem; border-radius:10rem;
      background:var(--pill); border:1px solid var(--line);
      font-size:.9rem;
    }
    .hud .res .v{ min-width:3.2ch; text-align:right; }
    .hud .spacer{ flex:1; }
    .hud .btn{
      background:var(--pill); border:1px solid var(--line);
      padding:.35rem .6rem; border-radius:.6rem; cursor:pointer; color:var(--text);
      font-weight:600;
    }

    /* Debug-Bar unten */
    .dbg{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      display:flex; gap:.5rem; align-items:center; padding:.5rem .75rem;
      height:var(--dbgHeight);
      background:linear-gradient(180deg, rgba(15,27,41,.75), rgba(15,27,41,.95));
      border-top:1px solid var(--line); backdrop-filter: blur(6px); box-shadow: var(--shadow);
    }
    .dbg .pill{
      background:var(--pill); border:1px solid var(--line);
      padding:.35rem .6rem; border-radius:10rem; font-size:.85rem; color:var(--text);
      user-select:none; cursor:pointer; white-space:nowrap;
    }
    .dbg .pill[aria-pressed="true"]{ outline:2px solid var(--accent); }
    .dbg .sep{ width:1px; height:1.75rem; background:var(--line); margin:0 .25rem; }
    .dbg .info{ font-size:.8rem; color:var(--muted); margin-left:auto; display:flex; gap:1rem; }

    /* Panels (Debug) */
    .panel{
      position:fixed; right:.75rem; bottom:calc(var(--dbgHeight) + .75rem); z-index:19;
      min-width:220px; max-width:min(90vw, 380px);
      background:var(--panel); border:1px solid var(--line); border-radius:.6rem;
      box-shadow: var(--shadow); padding:.5rem .75rem; display:none;
    }
    .panel.show{ display:block; }
    .panel h3{ margin:.2rem 0 .6rem; font-size:1rem; font-weight:600; }
    .kv{ display:grid; grid-template-columns: auto 1fr; gap:.25rem .75rem; font-size:.85rem; }
    .kv .k{ color:var(--muted); } .kv .v{ color:var(--text); word-break:break-word; }

    /* Start-Overlay: h√∂her, damit nicht von Debug-Bar verdeckt */
    .start-overlay{
      position:fixed; inset:0; z-index:30; display:none;
      align-items:flex-start; justify-content:center;
      padding-top:clamp(40px, 40vh, 55vh);
      background:linear-gradient(180deg, rgba(10,18,32,.55), rgba(10,18,32,.65));
      backdrop-filter: blur(8px);
    }
    .start-overlay.show{ display:flex; }
    .start-overlay .card{
      background:var(--panel2); border:1px solid var(--line);
      padding:1rem 1.25rem; border-radius:.8rem; box-shadow:var(--shadow);
      text-align:center; max-width:min(92vw, 520px);
    }
    .start-overlay .card h1{ margin:.2rem 0 .55rem; font-size:1.15rem; }
    .start-overlay .card p{ margin:.25rem 0 .75rem; color:var(--muted); }
    .start-overlay .row{ display:flex; gap:.5rem; justify-content:center; flex-wrap:wrap; }
    .start-overlay .btn{
      appearance:none; border:1px solid var(--line); background:var(--pill);
      color:var(--text); padding:.6rem .9rem; border-radius:.6rem; font-weight:600; cursor:pointer;
    }
    .start-overlay .btn.warn{ border-color:#7a2828; }

    /* Bau-Men√º (Farbschema wie Panels) */
    .build{
      position:fixed; left:.75rem; top:calc(var(--hudHeight) + .75rem); z-index:18;
      width:min(92vw, 360px); max-height:calc(100vh - var(--hudHeight) - var(--dbgHeight) - 1.5rem);
      background:var(--panel); border:1px solid var(--line); border-radius:.6rem;
      box-shadow: var(--shadow); padding:.6rem .75rem; display:none; overflow:auto;
    }
    .build.show{ display:block; }
    .build h3{ margin:.2rem 0 .6rem; font-size:1rem; font-weight:600; }
    .grid{
      display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:.5rem;
    }
    .tile{
      display:flex; flex-direction:column; align-items:center; gap:.25rem;
      background:var(--pill); border:1px solid var(--line); border-radius:.5rem; padding:.4rem;
      cursor:pointer;
    }
    .tile img{ width:48px; height:48px; image-rendering: pixelated; }
    .tile span{ font-size:.8rem; color:var(--muted); }

    /* Close-X: rechts oben ‚Äî nur im Vollbild sichtbar */
    .closeFS{
      position:fixed; right:.6rem; top:.6rem; z-index:25;
      display:none; /* Standard: aus */
      background:var(--pill); border:1px solid var(--line);
      color:var(--text); padding:.35rem .6rem; border-radius:.6rem; cursor:pointer; font-weight:700;
    }
    .closeFS.show{ display:inline-flex; }
  </style>
</head>
<body>
  <!-- Start-Hintergrund -->
  <div class="bg" id="bg" aria-hidden="true"></div>

  <!-- Ressourcen-HUD -->
  <div class="hud" id="hud">
    <div class="res"><span>ü™ô</span><span>Gold</span><span class="v" id="rGold">100</span></div>
    <div class="res"><span>ü™µ</span><span>Holz</span><span class="v" id="rWood">50</span></div>
    <div class="res"><spanüóø></span><span>Stein</span><span class="v" id="rStone">30</span></div>
    <div class="res"><span>üçñ</span><span>Nahrung</span><span class="v" id="rFood">25</span></div>
    <div class="spacer"></div>
    <button class="btn" id="btnBuild">Bauen</button>
  </div>

  <!-- Bau-Men√º -->
  <div class="build" id="build">
    <h3>Bauen</h3>
    <div class="grid">
      <!-- Platzhalter-Icons: nimm deine echten Sprites/Icons wenn vorhanden -->
      <button class="tile" data-type="hq"><img src="./assets/tiles/tileset.png" alt="HQ"/><span>Hauptquartier</span></button>
      <button class="tile" data-type="house"><img src="./assets/tiles/tileset.png" alt="Haus"/><span>Haus</span></button>
      <button class="tile" data-type="lumber"><img src="./assets/tiles/tileset.png" alt="Holzf√§ller"/><span>Holzf√§ller</span></button>
      <button class="tile" data-type="quarry"><img src="./assets/tiles/tileset.png" alt="Steinbruch"/><span>Steinbruch</span></button>
      <button class="tile" data-type="farm"><img src="./assets/tiles/tileset.png" alt="Farm"/><span>Farm</span></button>
      <button class="tile" data-type="mill"><img src="./assets/tiles/tileset.png" alt="M√ºhle"/><span>M√ºhle</span></button>
    </div>
  </div>

  <!-- Close-X (nur im Vollbild sichtbar) -->
  <button class="closeFS" id="btnCloseFS">‚úï</button>

  <!-- Debug: Info-Panel -->
  <div class="panel" id="pInfo" aria-hidden="true">
    <h3>Infos</h3>
    <div class="kv">
      <div class="k">DPR</div><div class="v" id="vDpr">‚Äì</div>
      <div class="k">Viewport</div><div class="v" id="vVp">‚Äì</div>
      <div class="k">Canvas</div><div class="v" id="vCv">‚Äì</div>
      <div class="k">Boot</div><div class="v">./boot.js (eingebettet)</div>
      <div class="k">Map</div><div class="v">./assets/maps/map-pro.json</div>
    </div>
  </div>

  <!-- Debug-Bar -->
  <div class="dbg" role="toolbar" aria-label="Debug-Leiste">
    <button class="pill" id="tglInfo" aria-pressed="false">‚ÑπÔ∏è Infos</button>
    <button class="pill" id="tglLayers" aria-pressed="false">üó∫Ô∏è Overlays</button>
    <span class="sep"></span>
    <button class="pill" id="btnReload">‚ü≥ Reload</button>
    <button class="pill" id="btnCenter">üéØ Zentrum</button>
    <span class="sep"></span>
    <div class="info">
      <span id="lblFps">FPS: ‚Äì</span>
      <span id="lblHint">Start ‚Üí BG blendet aus</span>
    </div>
  </div>

  <!-- Start-Overlay mit 4 Buttons -->
  <div class="start-overlay" id="start" data-autostart="0">
    <div class="card">
      <h1>Siedler‚ÄëMini</h1>
      <p>Willkommen! Bitte w√§hlen:</p>
      <div class="row">
        <button class="btn" id="btnStart">Start</button>
        <button class="btn" id="btnLoad">Laden</button>
        <button class="btn warn" id="btnReset">Reset</button>
        <button class="btn" id="btnFullscreen">Vollbild</button>
      </div>
    </div>
  </div>

  <!-- Boot/Glue -->
  <script type="module">
    import { Assets } from './core/asset.js';
    import { SiedlerMap } from './tools/map-runtime.js';

    // --- DOM
    const bg = document.getElementById('bg');
    const hud = document.getElementById('hud');
    const build = document.getElementById('build');
    const btnBuild = document.getElementById('btnBuild');

    const cv = document.createElement('canvas'); // wir ersetzen unten das existierende Canvas
    cv.id = 'game';
    document.body.insertBefore(cv, document.querySelector('.hud').nextSibling);
    const ctx = cv.getContext('2d', { alpha:false });

    // Debug
    const pInfo = document.getElementById('pInfo');
    const tglInfo = document.getElementById('tglInfo');
    const tglLayers = document.getElementById('tglLayers'); // (Platzhalter)
    const btnReload = document.getElementById('btnReload');
    const btnCenter = document.getElementById('btnCenter');
    const vDpr = document.getElementById('vDpr');
    const vVp = document.getElementById('vVp');
    const vCv = document.getElementById('vCv');

    // Start
    const start = document.getElementById('start');
    const btnStart = document.getElementById('btnStart');
    const btnLoad = document.getElementById('btnLoad');
    const btnReset = document.getElementById('btnReset');
    const btnFullscreen = document.getElementById('btnFullscreen');

    // Fullscreen Close-X
    const btnCloseFS = document.getElementById('btnCloseFS');

    // Canvas/DPR
    function resize(){
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      const w = innerWidth, h = innerHeight;
      cv.width = w * dpr; cv.height = h * dpr;
      cv.style.width = w+'px'; cv.style.height = h+'px';
      ctx.setTransform(dpr,0,0,dpr,0,0);
      vDpr.textContent = dpr.toFixed(2);
      vVp.textContent = `${w}√ó${h}`; vCv.textContent = `${cv.width}√ó${cv.height}`;
    }
    addEventListener('resize', resize);
    Assets.imageRenderingCrisp(cv); resize();

    // Debug UI
    function togglePanel(btn, panel){
      const vis = panel.classList.toggle('show');
      btn.setAttribute('aria-pressed', String(vis));
      panel.setAttribute('aria-hidden', String(!vis));
    }
    tglInfo.addEventListener('click', ()=> togglePanel(tglInfo, pInfo));
    tglLayers.addEventListener('click', ()=> alert('Overlay‚ÄëMen√º folgt.'));

    btnReload.addEventListener('click', ()=> location.reload());
    const view = { x:0, y:0, w:0, h:0 };
    btnCenter.addEventListener('click', ()=> { view.x = 0; view.y = 0; });

    // Ressourcen (Dummy-Ticker, zeigt dass HUD lebt)
    const R = { gold:100, wood:50, stone:30, food:25 };
    const q = (id)=> document.getElementById(id);
    function updateRes(){
      q('rGold').textContent = R.gold;
      q('rWood').textContent = R.wood;
      q('rStone').textContent = R.stone;
      q('rFood').textContent = R.food;
    }
    updateRes();

    // Bau-Men√º Toggle
    btnBuild.addEventListener('click', ()=> build.classList.toggle('show'));
    build.addEventListener('click', (ev)=>{
      const b = ev.target.closest('.tile');
      if (!b) return;
      const type = b.dataset.type;
      // TODO: hier sp√§ter Platzierungsmodus aktivieren
      build.classList.remove('show');
    });

    // Vollbild-X nur im Fullscreen anzeigen
    function syncFSButton(){
      const fs = !!document.fullscreenElement;
      btnCloseFS.classList.toggle('show', fs);
    }
    document.addEventListener('fullscreenchange', syncFSButton);
    syncFSButton();

    // Startfenster anzeigen
    start.classList.add('show');

    btnStart.addEventListener('click', ()=>{
      start.classList.remove('show');

      // BG weich ausblenden & danach deaktivieren
      bg.classList.add('fade');
      bg.addEventListener('transitionend', ()=> bg.classList.add('hidden'), { once:true });

      begin(); // Map erst jetzt laden/zeichnen
    });
    btnLoad.addEventListener('click', ()=> alert('Laden: Slots/Autosaves kommen sp√§ter.'));
    btnReset.addEventListener('click', ()=> location.reload());
    btnFullscreen.addEventListener('click', ()=>{
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else document.exitFullscreen();
    });
    btnCloseFS.addEventListener('click', ()=>{
      if (document.fullscreenElement) document.exitFullscreen();
    });

    // Welt/Renderer ‚Äì erst nach Start
    let world=null, started=false, _lf=performance.now();
    async function begin(){
      if (started) return; started=true;

      await Assets.loadAll({
        images:['./assets/tiles/tileset.png'],
        json:['./assets/tiles/tileset.json','./assets/maps/map-pro.json']
      });
      const worldJson = await Assets.get('./assets/maps/map-pro.json');
      world = new SiedlerMap({
        tileResolver:(n)=>'./assets/'+n,
        onReady:()=> loop()
      });
      await world.loadFromObject(worldJson);
    }

    function tickFps(){
      const now = performance.now();
      const dt = now - _lf; _lf = now;
      document.getElementById('lblFps').textContent = 'FPS: ' + Math.round(1000/(dt||16.7));
    }

    function loop(){
      tickFps();
      ctx.clearRect(0,0,cv.width,cv.height);
      view.w = cv.width; view.h = cv.height;

      if (world){
        world.draw(ctx, view);
      }

      requestAnimationFrame(loop);
    }
  </script>
</body>
</html>
