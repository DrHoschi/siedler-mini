<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>Siedler‑Mini V15 (DEV)</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <!-- HUD: Ressourcen + Buttons (position:fixed; werden bei Fullscreen automatisch mitgenommen) -->
  <header id="hud">
    <div class="chips" id="res">
      <span class="chip">Holz <b id="resWood">0</b></span>
      <span class="chip">Stein <b id="resStone">0</b></span>
      <span class="chip">Nahrung <b id="resFood">0</b></span>
      <span class="chip">Gold <b id="resGold">0</b></span>
      <span class="chip">Träger <b id="resCarrier">0</b></span>
      <span class="chip">Tool: <b id="hudTool">Zeiger</b></span>
      <span class="chip">Zoom <b id="hudZoom">1.00x</b></span>
    </div>

    <div class="actions">
      <button class="btn" id="btnCenter">Zentrieren</button>
      <button class="btn" id="btnDebug">Debug</button>
      <button class="btn" id="btnFullscreen">Vollbild</button>
      <button class="btn primary" id="btnBuild">Bauen</button>
    </div>
  </header>

  <!-- Bau‑Palette (ein/aus) -->
  <aside id="buildPalette" hidden>
    <button class="btn tool" data-tool="pointer">Zeiger</button>
    <!-- Straßen sind momentan deaktiviert; Button bleibt auskommentiert
    <button class="btn tool" data-tool="road">Straße</button>
    -->
    <button class="btn tool" data-tool="hq">HQ</button>
    <button class="btn tool" data-tool="depot">Depot</button>
    <button class="btn tool" data-tool="woodcutter">Holzfäller</button>
    <button class="btn danger tool" data-tool="erase">Abriss</button>
  </aside>

  <!-- Spielfeld -->
  <main id="stage">
    <canvas id="game"></canvas>
  </main>

  <!-- Start‑Overlay (nur Info) -->
  <div id="startOverlay">
    <div class="card">
      <h3>Siedler‑Mini V15 (Mobile)</h3>
      <p>
        <b>Zeiger:</b> ziehen = Karte verschieben · <b>Pinch</b> = zoomen ·
        <b>Kurz‑Tap</b> = bauen (bei aktivem Bau‑Tool)<br />
        <b>Tipp:</b> Doppeltipp auf die Karte zoomt stufenweise.
      </p>
      <div class="row">
        <button class="btn primary" id="btnStart">Start</button>
        <button class="btn" id="btnFSInCard">Vollbild</button>
        <button class="btn danger" id="btnReset">Reset</button>
      </div>
    </div>
  </div>

  <!-- Debug‑Konsole (ziehbar) -->
  <div id="debug" hidden>
    <div class="debugHead">
      <span>Debug (ziehen zum Verschieben)</span>
      <button id="dbgClose">×</button>
    </div>
    <pre id="debugOut"></pre>
  </div>

  <footer id="version">DEV 16.8.2025</footer>

  <script type="module">
    import { game } from './game.js';

    // ---------- Mini-Hilfsfunktionen ----------
    const $ = sel => document.querySelector(sel);
    const log = (...a)=>game.debug?.log(...a);

    // ---------- Buttons verdrahten ----------
    $('#btnStart').onclick = () => game.startGame({
      canvas: $('#game'),
      onHUD: (k,v) => {
        if (k==='Zoom') $('#hudZoom').textContent = v;
        if (k==='Tool') $('#hudTool').textContent = v;
      }
    });

    $('#btnReset').onclick = () => location.reload();

    const requestFS = async () => {
      const elem = document.documentElement;
      try {
        if (elem.requestFullscreen) await elem.requestFullscreen();
        else if (elem.webkitRequestFullscreen) await elem.webkitRequestFullscreen();
        else alert('Vollbild wird in diesem Browser/Modus nicht unterstützt.\nTipp: iOS Safari ab iOS 16 oder „Zum Homescreen hinzufügen“.');
      } catch(e){ alert('Fullscreen: ' + e.message); }
    };
    $('#btnFullscreen').onclick = requestFS;
    $('#btnFSInCard').onclick = requestFS;

    $('#btnCenter').onclick = () => game.centerOnContent?.();

    // Debug an/aus + verschiebbar
    const dbg = $('#debug');
    const dbgOut = $('#debugOut');
    $('#btnDebug').onclick = () => {
      dbg.hidden = !dbg.hidden;
      game.debug?.setEnabled(!dbg.hidden);
    };
    $('#dbgClose').onclick = () => { dbg.hidden = true; game.debug?.setEnabled(false); };

    // Debug draggable
    (() => {
      let dragging=false, sx=0, sy=0, ox=0, oy=0;
      const head = dbg.querySelector('.debugHead');
      head.addEventListener('pointerdown', e=>{
        dragging=true; sx=e.clientX; sy=e.clientY;
        const r = dbg.getBoundingClientRect(); ox=r.left; oy=r.top;
        dbg.setPointerCapture?.(e.pointerId);
      });
      window.addEventListener('pointermove', e=>{
        if (!dragging) return;
        const nx = ox + (e.clientX-sx);
        const ny = oy + (e.clientY-sy);
        dbg.style.left = Math.max(8, Math.min(window.innerWidth-200, nx)) + 'px';
        dbg.style.top  = Math.max(8, Math.min(window.innerHeight-100, ny)) + 'px';
      }, {passive:true});
      window.addEventListener('pointerup', ()=> dragging=false, {passive:true});
    })();

    // Ausgabe an Debug weiterreichen
    game.debug = {
      setEnabled: (on)=> game.setDebug?.(on),
      log: (...a) => {
        if (dbg.hidden) return;
        dbgOut.textContent += a.join(' ') + '\n';
        dbgOut.scrollTop = dbgOut.scrollHeight;
      }
    };

    // Bau‑Palette
    const palette = $('#buildPalette');
    $('#btnBuild').onclick = () => {
      palette.hidden = !palette.hidden;
    };
    palette.addEventListener('click', (e)=>{
      const btn = e.target.closest('.tool');
      if (!btn) return;
      const tool = btn.dataset.tool;
      game.setTool(tool);
      $('#hudTool').textContent = btn.textContent;
      palette.hidden = true; // Palette schließt sich beim Tool‑Wechsel
    });

    // Start‑Overlay sichtbar lassen bis „Start“
    // (Klicks gehen aber schon auf die Karte durch – ist Absicht)
  </script>
</body>
</html>
