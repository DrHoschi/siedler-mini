<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"
  />
  <meta name="theme-color" content="#0b1628" />
  <title>Siedler-Mini V14.7 (Mobil)</title>

  <!-- Basis-Styles (Canvas + HUD). Mobil-Spezifika k√∂nnen in separaten CSS-Dateien √ºberschrieben werden -->
  <style>
    :root{
      color-scheme: dark;
      --bg:#0b1628; --panel:#122238; --panel2:#0f1d31;
      --line:#2b3b53; --text:#cfe3ff; --muted:#9fb3cc;
      --pill:#0f1b29; --ok:#1a7f3e; --warn:#982e2e;
      --shadow: 0 20px 60px rgba(0,0,0,.35);
    }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); }
    body{ overflow:hidden; -webkit-touch-callout:none; -webkit-user-select:none; user-select:none; }
    canvas{ display:block; width:100vw; height:100vh; image-rendering:pixelated; }
    /* optionale HUD-Container, falls vom Spiel genutzt */
    #hud, #topbar, #bottombar { position:fixed; left:0; right:0; pointer-events:auto; }
    #topbar{ top:0; padding:8px; display:flex; gap:8px; justify-content:center; }
    #bottombar{ bottom:0; padding:8px; display:flex; gap:8px; justify-content:center; }
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      background:var(--pill); border:1px solid var(--line); box-shadow:var(--shadow);
      font: 600 14px/1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .btn{
      display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border-radius:12px;
      background:var(--panel); border:1px solid var(--line); color:var(--text);
      font:600 14px/1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .btn:active{ transform:translateY(1px); }
    /* Platz f√ºr Start-Overlay, falls boot.js eines einblendet */
    #start-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35); backdrop-filter: blur(6px); z-index:50; }
    #start-overlay.active{ display:flex; }
  </style>

  <!-- OPTIONAL: Apple PWA Touch-Einstellungen k√∂nnten hier folgen -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
</head>
<body>
  <!-- Haupt-Canvas (dein Renderer greift idR. √ºber JS zu) -->
  <canvas id="game"></canvas>

  <!-- Beispiel-UI (nur Platzhalter; deine boot.js kann eigene Elemente erzeugen) -->
  <div id="topbar" aria-hidden="true" style="pointer-events:none">
    <!-- Buttons k√∂nnen von boot.js aktiviert/ersetzt werden -->
  </div>
  <div id="bottombar" aria-hidden="true" style="pointer-events:none">
    <!-- Buttons k√∂nnen von boot.js aktiviert/ersetzt werden -->
  </div>

  <!-- Start-Overlay (wird nur genutzt, wenn boot.js es toggelt) -->
  <div id="start-overlay">
    <button class="btn" id="start-btn">Start</button>
  </div>

  <!-- ===================================================================== -->
  <!--  Runtime-Settings f√ºr Assets (Cache-Busting, iOS-Fallback)            -->
  <!--  Wichtig: VOR boot.js, damit Settings schon beim ersten Load greifen. -->
  <!-- ===================================================================== -->
  <script type="module">
    import Assets from './core/asset.js';
    // Entwicklung: aggressiv gegen Cache/Bitmap-Edgecases (iOS)
    Assets.setVersion(String(Date.now()));   // hartes Cache-Busting
    Assets.setCacheMode('no-store');         // immer frisch laden
    Assets.setUseImageBitmap(false);         // <img>-Fallback erzwingen
    // Tipp (Produktion sp√§ter):
    // Assets.setVersion('build-abc123'); Assets.setCacheMode('default'); Assets.setUseImageBitmap(true);
  </script>

  <!-- Spielstart / Glue-Code -->
  <script type="module" src="./boot.js"></script>

  <!-- ===================================================================== -->
  <!-- Emergency Debug HUD: Fehlerbanner, Tap-Logger, Overlay-Killer         -->
  <!-- Toggle: Button üêû unten rechts oder 3√ó schnell tippen                 -->
  <!-- ===================================================================== -->
  <script>
  (function(){
    const style = document.createElement('style');
    style.textContent = `
    #dbgBtn{position:fixed;right:14px;bottom:14px;z-index:99999;border:0;border-radius:14px;
            width:44px;height:44px;font-size:22px;box-shadow:var(--shadow,0 8px 24px rgba(0,0,0,.35));
            background:var(--panel,#122238);color:var(--text,#cfe3ff)}
    #dbgWrap{position:fixed;right:14px;bottom:70px;z-index:99999;min-width:260px;max-width:90vw;
             background:var(--panel2,#0f1d31);color:var(--text,#cfe3ff);border-radius:12px;
             box-shadow:var(--shadow,0 20px 60px rgba(0,0,0,.35));padding:10px;display:none}
    #dbgWrap.active{display:block}
    #dbgWrap button{margin:6px 6px 0 0;border:0;border-radius:10px;padding:8px 10px;
                    background:#1c2b44;color:#cfe3ff}
    #dbgErr{position:fixed;left:8px;top:8px;z-index:99999;background:#7d1f1f;color:#fff;
            padding:8px 10px;border-radius:8px;display:none;max-width:90vw;white-space:pre-wrap}
    .tapdot{position:fixed;width:18px;height:18px;border-radius:50%;background:rgba(255,255,255,.25);
            border:2px solid rgba(255,255,255,.7);pointer-events:none;transform:translate(-50%,-50%);
            z-index:99998;animation:tapdot .6s ease-out forwards}
    @keyframes tapdot{to{opacity:0;transform:translate(-50%,-50%) scale(1.8)}}
    `;
    document.head.appendChild(style);

    const btn = Object.assign(document.createElement('button'), {id:'dbgBtn',textContent:'üêû',title:'Debug'});
    const wrap = Object.assign(document.createElement('div'), {id:'dbgWrap',innerHTML:`
      <div style="font-weight:600;margin:4px 0 6px">Debug-Werkzeuge</div>
      <button id="dbgTap">Tap-Log: AUS</button>
      <button id="dbgKill">Overlays aus</button>
      <button id="dbgReload">Hard-Reload</button>
      <div id="dbgInfo" style="margin-top:8px;font-size:12px;opacity:.8"></div>
    `});
    const err = Object.assign(document.createElement('div'), {id:'dbgErr'});
    document.body.append(btn, wrap, err);

    let tapLog=false, tripleTap=0, tripleTimer=null;
    function setInfo(s){ wrap.querySelector('#dbgInfo').textContent = s; }
    function showErr(s){ err.textContent = s; err.style.display='block';
      clearTimeout(err._t); err._t=setTimeout(()=> err.style.display='none', 8000); }

    // Fehler sichtbar machen
    window.addEventListener('error', e => showErr('Error: ' + (e.message||e.error||'unknown')));
    window.addEventListener('unhandledrejection', e => showErr('Promise: ' + (e.reason||'unknown')));

    // Tap-Visualizer
    function tapDot(x,y){ const d=document.createElement('div'); d.className='tapdot'; d.style.left=x+'px'; d.style.top=y+'px'; document.body.appendChild(d); setTimeout(()=>d.remove(),650); }
    function onPointer(ev){
      if(!tapLog) return;
      tapDot(ev.clientX, ev.clientY);
      const el = document.elementFromPoint(ev.clientX, ev.clientY);
      if(!el) return;
      const name = (el.id?('#'+el.id):'') + (el.className?('.'+String(el.className).split(' ').join('.')):'');
      console.log('[TAP]', ev.type, el.tagName+name, getComputedStyle(el).pointerEvents, 'z=', getComputedStyle(el).zIndex);
    }

    // HUD Controls
    btn.onclick = ()=> wrap.classList.toggle('active');
    wrap.querySelector('#dbgTap').onclick = function(){
      tapLog=!tapLog; this.textContent = 'Tap-Log: '+(tapLog?'AN':'AUS');
      const opts={capture:true,passive:true};
      const fns=['pointerdown','pointerup','click','touchstart','touchend'];
      fns.forEach(t=> (tapLog? document.addEventListener(t,onPointer,opts)
                             : document.removeEventListener(t,onPointer,opts)));
      setInfo(tapLog?'Taps werden geloggt (Konsole √∂ffnen).':'');
    };
    wrap.querySelector('#dbgKill').onclick = ()=>{
      // Blendet typische Blocker-Overlays aus
      const sel='[class*="overlay"],[id*="overlay"],[class*="modal"],[id*="modal"],[class*="glass"],[class*="backdrop"]';
      document.querySelectorAll(sel).forEach(el=>{
        el.dataset._prev_display = getComputedStyle(el).display;
        el.style.display='none';
      });
      setInfo('Overlays mit *overlay/modal/glass/backdrop* wurden ausgeblendet.');
    };
    wrap.querySelector('#dbgReload').onclick = ()=> location.reload(true);

    // 3√ó schnelles Tippen ‚Üí HUD umschalten
    document.addEventListener('pointerdown', ()=>{
      tripleTap++; clearTimeout(tripleTimer);
      tripleTimer=setTimeout(()=>{ tripleTap=0; }, 550);
      if(tripleTap>=3){ wrap.classList.toggle('active'); tripleTap=0; }
    }, {passive:true});
  })();
  </script>

  <noscript>
    <div style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#300;color:#fff;font:600 16px system-ui">
      JavaScript ist deaktiviert ‚Äì das Spiel kann nicht gestartet werden.
    </div>
  </noscript>
</body>
</html>
